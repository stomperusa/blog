---
title: Multiple Gauge Plots with Facet Wrap
author: David Stomski
date: '2020-10-18'
slug: multiple-gauge-plots-with-facet-wrap
categories:
  - R
tags: []
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>
<link href="/rmarkdown-libs/lightable/lightable.css" rel="stylesheet" />


<div id="intro" class="section level2">
<h2>Intro</h2>
<p>Here are some good examples of how to generate gauge plots including multiple gauge plots in R found at <a href="https://stackoverflow.com/questions/24900903/how-to-draw-gauge-chart-in-r">stackoverflow</a>. My use case, however, requires the ability to vary the number of plots based on the number of metrics fed into the function without having to adjust the code. Below is such a function that borrows from these examples and leverages <strong>ggplot2::facet_wrap</strong>.</p>
</div>
<div id="gauge-plots-with-facet-wrap" class="section level2">
<h2>Gauge Plots with Facet Wrap</h2>
<p>My data is captured in a table with a column “pos” for the position of the needle, and “metric” for the name of the metric.</p>
<table class=" lightable-paper" style="font-size: 14px; font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; width: auto !important; ">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-1">Table 1: </span>Metrics Data
</caption>
<thead>
<tr>
<th style="text-align:right;">
pos
</th>
<th style="text-align:left;">
metric
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
94
</td>
<td style="text-align:left;">
Metric 1
</td>
</tr>
<tr>
<td style="text-align:right;">
23
</td>
<td style="text-align:left;">
Metric 2
</td>
</tr>
<tr>
<td style="text-align:right;">
44
</td>
<td style="text-align:left;">
Metric 3
</td>
</tr>
<tr>
<td style="text-align:right;">
57
</td>
<td style="text-align:left;">
Metric 4
</td>
</tr>
<tr>
<td style="text-align:right;">
17
</td>
<td style="text-align:left;">
Metric 5
</td>
</tr>
<tr>
<td style="text-align:right;">
79
</td>
<td style="text-align:left;">
Metric 6
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
Metric 7
</td>
</tr>
<tr>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
Metric 8
</td>
</tr>
</tbody>
</table>
<p>The <strong>gauge_plot()</strong> function takes three parameters. The first is the two-column data frame that has variables “pos” for the needle position, and “metric” for the name of the metric. The second optional parameter allows you to change the breaks. The final parameter controls the number of columns generated by <strong>facet_wrap()</strong>.</p>
<p>Here is the output that captures the 8 metrics in two columns with the default breaks.</p>
<p><img src="/post/2020-10-18-multiple-gauge-plots-with-facet-wrap_files/figure-html/example-1.png" width="672" /></p>
</div>
<div id="the-code" class="section level2">
<h2>The Code</h2>
<p>Here’s the code for the function.</p>
<pre class="r"><code>gauge_plot &lt;- function(vals, breaks=c(0,30,70,100), ncol= NULL) {
    require(ggplot2)
    require(dplyr)
    require(tidyr)
    
    if (!is.data.frame(vals)) stop(&quot;Vals must be a dataframe&quot;)
    if (!dim(vals)[2]==2) stop(&quot;Vals must have two columns&quot;)
    if (!is.numeric(vals$pos)) stop(&quot;Dataframe variable pos must be numeric&quot;)
    
    
    # function to generate polygons
    get_poly &lt;- function(a,b,r1=0.5,r2=1.0) {
        th.start &lt;- pi*(1-a/100)
        th.end &lt;- pi*(1-b/100)
        th &lt;- seq(th.start,th.end,length=100)
        x &lt;- c(r1*cos(th),rev(r2*cos(th)))
        y &lt;- c(r1*sin(th),rev(r2*sin(th)))
        df &lt;- data.frame(x,y)
        return(df)
    }
    
    
    # create the segments based on the breaks
    segments &lt;- list()
    seg_names &lt;- tibble(x = c(&quot;a&quot;, &quot;c&quot;, &quot;e&quot;), y = c(&quot;b&quot;, &quot;d&quot; ,&quot;f&quot;))
    
    for(n in 1:3){
        i &lt;-breaks[n]
        j &lt;-breaks[n+1]
        df &lt;- get_poly(i, j)       
        names(df) &lt;- seg_names[n,]
        segments$df[[n]] &lt;- df
    }

    dfs &lt;- bind_cols(segments)

    # create set of segments for each metric 
    pnt &lt;- tibble()
    for (name in vals$metric){
        pnt[1:nrow(dfs), name] &lt;- name
    }
    
    dfp &lt;- dfs %&gt;% 
        cbind(pnt) %&gt;% 
        pivot_longer(-c(a:f), names_to = &quot;metric&quot;) %&gt;% 
        select(-value)
    
    # generate the needles
    needles &lt;- list()
    for(p in 1:nrow(vals)){
        i &lt;-vals$pos[p] - 1
        j &lt;-vals$pos[p] + 1
        r1 &lt;- 0.2
        df &lt;- get_poly(i, j, r1)  
        df$metric &lt;- vals$metric[p]
        needles$df[[p]] &lt;- df
    }
    
    dfn &lt;- bind_rows(needles)
    
    
    # graph
    ggplot()+
        geom_polygon(data=dfp, aes(a,b), fill=&quot;red&quot;)+
        geom_polygon(data=dfp, aes(c,d), fill=&quot;gold&quot;)+
        geom_polygon(data=dfp, aes(e,f), fill=&quot;forestgreen&quot;)+
        geom_polygon(data=dfn, aes(x,y))+
        geom_text(data=as.data.frame(breaks), size=3, fontface=&quot;bold&quot;, vjust=0,
                  aes(x=1.05*cos(pi*(1-breaks/100)),y=1.05*sin(pi*(1-breaks/100)),label=breaks))+
        geom_text(data=vals, aes(x=0,y=0), label=paste0(vals$pos,&quot;%&quot;), vjust=0, size=4, fontface=&quot;bold&quot;)+
        coord_fixed()+
        theme_bw()+
        theme(axis.text=element_blank(),
              axis.title=element_blank(),
              axis.ticks=element_blank(),
              panel.grid=element_blank(),
              panel.border=element_blank()) +
        facet_wrap(~metric, strip.position = &quot;bottom&quot;, ncol = ncol) +
        labs(title = &quot;Multiple Gauge Plots w/ Facet Wrap&quot;)
}</code></pre>
</div>
